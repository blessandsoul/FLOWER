// ==========================================
// FLOWER SERVER - PRISMA SCHEMA
// Simplified role system with USER and ADMIN
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  USER  // Default role for regular users
  ADMIN // Platform administrators
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  phoneNumber  String?   @map("phone_number") @db.VarChar(20)
  isActive     Boolean   @default(true) @map("is_active")
  tokenVersion Int       @default(0) @map("token_version")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Multi-role support via junction table (users can have multiple roles)
  roles UserRoleAssignment[]

  // Email verification
  emailVerified              Boolean   @default(false) @map("email_verified")
  verificationToken          String?   @map("verification_token") @db.VarChar(64)
  verificationTokenExpiresAt DateTime? @map("verification_token_expires_at")

  // Password reset
  resetPasswordToken          String?   @map("reset_password_token") @db.VarChar(64)
  resetPasswordTokenExpiresAt DateTime? @map("reset_password_token_expires_at")

  // Account lockout (brute force protection)
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")

  // Sessions
  sessions UserSession[]

  @@index([email])
  @@index([isActive])
  @@index([verificationToken])
  @@index([resetPasswordToken])
  @@map("users")
}

// Junction table for user roles (supports multiple roles per user)
model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      UserRole
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
  @@map("user_roles")
}

model UserSession {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  refreshTokenHash String    @map("refresh_token_hash")
  expiresAt        DateTime  @map("expires_at")
  revokedAt        DateTime? @map("revoked_at")
  userAgent        String?   @map("user_agent") @db.VarChar(512)
  ipAddress        String?   @map("ip_address") @db.VarChar(45)
  createdAt        DateTime  @default(now()) @map("created_at")
  lastUsedAt       DateTime  @default(now()) @map("last_used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("user_sessions")
}

// ==========================================
// PRODUCT LOOKUP TABLES
// ==========================================

model Color {
  id        Int       @id @default(autoincrement()) @db.UnsignedInt
  name      String    @unique @db.VarChar(100)
  createdAt DateTime  @default(now()) @map("created_at")

  products Product[]

  @@map("colors")
}

model Grower {
  id        Int       @id @default(autoincrement()) @db.UnsignedInt
  name      String    @unique @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")

  products Product[]

  @@map("growers")
}

model Origin {
  id        Int       @id @default(autoincrement()) @db.UnsignedInt
  name      String    @unique @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")

  products Product[]

  @@map("origins")
}

model Tag {
  id        Int       @id @default(autoincrement()) @db.UnsignedInt
  name      String    @unique @db.VarChar(100)
  slug      String    @unique @db.VarChar(100)
  createdAt DateTime  @default(now()) @map("created_at")

  products ProductTag[]

  @@map("tags")
}

// ==========================================
// PRODUCTS
// ==========================================

model Product {
  id              Int       @id @default(autoincrement()) @db.UnsignedInt
  name            String    @db.VarChar(500)

  // Foreign keys to lookup tables
  colorId         Int?      @map("color_id") @db.UnsignedInt
  growerId        Int?      @map("grower_id") @db.UnsignedInt
  originId        Int?      @map("origin_id") @db.UnsignedInt

  // Stock & ordering
  stock           Int       @default(0) @db.UnsignedInt
  orderPer        Int       @default(1) @map("order_per") @db.UnsignedInt

  // Images
  imageUrl        String?   @map("image_url") @db.VarChar(500)
  imageFilename   String?   @map("image_filename") @db.VarChar(255)

  // Metadata
  sourceScrapedAt DateTime? @map("source_scraped_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  color           Color?    @relation(fields: [colorId], references: [id], onDelete: SetNull)
  grower          Grower?   @relation(fields: [growerId], references: [id], onDelete: SetNull)
  origin          Origin?   @relation(fields: [originId], references: [id], onDelete: SetNull)
  tags            ProductTag[]
  priceTiers      PriceTier[]
  images          ProductImage[]

  @@unique([name, growerId])
  @@index([name(length: 100)])
  @@index([colorId])
  @@index([growerId])
  @@index([originId])
  @@index([stock])
  @@map("products")
}

// Many-to-many junction table for product tags
model ProductTag {
  productId Int @map("product_id") @db.UnsignedInt
  tagId     Int @map("tag_id") @db.UnsignedInt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tags")
}

// Price tiers for products
model PriceTier {
  id          Int     @id @default(autoincrement()) @db.UnsignedInt
  productId   Int     @map("product_id") @db.UnsignedInt
  minQuantity Int     @map("min_quantity") @db.UnsignedInt
  price       Decimal @db.Decimal(10, 2)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, minQuantity])
  @@index([productId])
  @@map("price_tiers")
}

// Product images (detail page images from scraper)
model ProductImage {
  id            Int      @id @default(autoincrement()) @db.UnsignedInt
  productId     Int      @map("product_id") @db.UnsignedInt
  imageUrl      String?  @map("image_url") @db.VarChar(500)
  imageFilename String?  @map("image_filename") @db.VarChar(255)
  displayOrder  Int      @default(0) @map("display_order") @db.UnsignedInt
  createdAt     DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}
